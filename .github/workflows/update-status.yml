name: Update Status

on:
  schedule:
    - cron: '0 4 * * *'  # 4 AM UTC daily (2 hours after test-plans runs at 2 AM)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-status:
    runs-on: self-hosted
    outputs:
      changes_committed: ${{ steps.commit.outputs.changes_committed }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create status data directory
        run: mkdir -p static/data/status

      - name: Fetch interop results from test-plans
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail

          echo "Fetching combined interop results from libp2p/test-plans..."

          # Fetch the combined YAML file
          if gh api repos/libp2p/test-plans/contents/results/daily-full-interop.yml \
              --jq '.content' 2>/dev/null | base64 -d > static/data/status/interop-results.yml; then
            echo "✓ Downloaded interop-results.yml"
          else
            echo "✗ Failed to download interop-results.yml (may not exist yet)"
            # Create a minimal placeholder file so the site still builds
            {
              echo '# Placeholder - results not yet available'
              echo 'generated-at: null'
              echo 'workflow-run: null'
              echo 'transport: null'
              echo 'hole-punch: null'
              echo 'perf: null'
              echo 'box-plots:'
              echo '  upload: null'
              echo '  download: null'
              echo '  latency: null'
            } > static/data/status/interop-results.yml
          fi

          # Fetch box plot images
          for plot in upload download latency; do
            if gh api repos/libp2p/test-plans/contents/results/boxplot-${plot}.png \
                --jq '.content' 2>/dev/null | base64 -d > static/data/status/boxplot-${plot}.png; then
              echo "✓ Downloaded boxplot-${plot}.png"
            else
              echo "→ boxplot-${plot}.png not found (may not exist yet)"
              rm -f static/data/status/boxplot-${plot}.png
            fi
          done

      - name: Validate YAML
        run: |
          python3 -c "import yaml; yaml.safe_load(open('static/data/status/interop-results.yml'))" && \
            echo "✓ YAML validation passed" || \
            echo "✗ YAML validation failed"

      - name: Commit and push if changed
        id: commit
        run: |
          set -euo pipefail

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Stage all status data files
          git add static/data/status/

          # Check if there are changes
          if git diff --cached --quiet; then
            echo "→ No changes to commit"
            echo "changes_committed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Get timestamp from results file if available
          GENERATED_AT=$(grep -oP 'generatedAt: "\K[^"]+' static/data/status/interop-results.yml 2>/dev/null || echo "unknown")

          git commit -m "chore: update interop status data [skip ci]" \
                     -m "Results from: $GENERATED_AT" \
                     -m "Source: https://github.com/libp2p/test-plans/tree/master/results"

          git push origin main
          echo "✓ Changes committed and pushed"
          echo "changes_committed=true" >> $GITHUB_OUTPUT
