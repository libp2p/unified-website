{% extends "base.html" %}

{% block title %}Interoperability Status{% endblock %}

{% block body_class %}status{% endblock %}
{% block main_class %}{% endblock %}

{% block content %}
{# Load interop results data at build time #}
{% set data = load_data(path="static/data/status/interop-results.yml", format="yaml", required=false) %}

<div class="status-page">
    <div class="status-layout">
        {# Main content #}
        <div class="status-content">
            {# Header #}
            <header class="status-header">
                <h1 class="status-header__title">Interoperability Status</h1>
                <p class="status-header__description">
                    Real-time interoperability test results across libp2p implementations.
                    These tests verify that different implementations can communicate with each other.
                </p>
                <div class="status-header__updated">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    {% if data and data["generated-at"] %}
                    Last updated: <time datetime="{{ data["generated-at"] }}">{{ data["generated-at"] | date(format="%B %d, %Y at %H:%M UTC") }}</time>
                    {% if data["workflow-run"] %}
                    <a href="{{ data["workflow-run"] }}" target="_blank" rel="noopener noreferrer" class="status-header__workflow-link">(view run)</a>
                    {% endif %}
                    {% else %}
                    Last updated: <time id="last-updated">Loading...</time>
                    {% endif %}
                </div>
            </header>

            {# Legend #}
            <div class="status-legend">
                <div class="status-legend__item">
                    <span class="status-legend__color status-legend__color--pass"></span>
                    <span>Pass</span>
                </div>
                <div class="status-legend__item">
                    <span class="status-legend__color status-legend__color--fail"></span>
                    <span>Fail</span>
                </div>
                <div class="status-legend__item">
                    <span class="status-legend__color status-legend__color--partial"></span>
                    <span>Partial</span>
                </div>
                <div class="status-legend__item">
                    <span class="status-legend__color status-legend__color--na"></span>
                    <span>N/A</span>
                </div>
            </div>

            {# Transport Interop Section #}
            <section class="status-section" id="transport">
                <header class="status-section__header">
                    <h2 class="status-section__title">Transport Interoperability</h2>
                    <p class="status-section__description">
                        Tests verifying that different transport implementations (TCP, QUIC, WebSocket, etc.) can communicate.
                    </p>
                </header>

                {% if data and data.transport and data.transport.results %}
                {# Show summary #}
                <div class="test-run-info">
                    <div class="test-run-info__item">
                        <strong>Total:</strong>
                        <span>{{ data.transport.summary.total }}</span>
                    </div>
                    <div class="test-run-info__item">
                        <strong>Passed:</strong>
                        <span class="status-text--pass">{{ data.transport.summary.passed }}</span>
                    </div>
                    <div class="test-run-info__item">
                        <strong>Failed:</strong>
                        <span class="status-text--fail">{{ data.transport.summary.failed }}</span>
                    </div>
                </div>

                {# Extract unique implementations, transports, etc. #}
                {% set_global transport_dialers = [] %}
                {% set_global transport_listeners = [] %}
                {% set_global transport_transports = [] %}
                {% for test in data.transport.results %}
                    {% if test.dialer not in transport_dialers %}
                        {% set_global transport_dialers = transport_dialers | concat(with=test.dialer) %}
                    {% endif %}
                    {% if test.listener not in transport_listeners %}
                        {% set_global transport_listeners = transport_listeners | concat(with=test.listener) %}
                    {% endif %}
                    {% if test.transport not in transport_transports %}
                        {% set_global transport_transports = transport_transports | concat(with=test.transport) %}
                    {% endif %}
                {% endfor %}

                {# Generate a grid for each transport type #}
                {% for transport_name in transport_transports | sort %}
                <div class="status-section__subsection">
                    <h3 class="status-section__subtitle">{{ transport_name | upper }}</h3>
                    <div class="status-grid-wrapper">
                        <table class="status-grid__table">
                            <thead>
                                <tr>
                                    <th>Dialer \ Listener</th>
                                    {% for listener in transport_listeners | sort %}
                                    <th class="impl-header">
                                        <span class="impl-header__name">{{ listener | split(pat="-") | first }}</span>
                                        <span class="impl-header__version">{{ listener | split(pat="-") | slice(start=1) | join(sep="-") }}</span>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for dialer in transport_dialers | sort %}
                                <tr>
                                    <th class="impl-header">
                                        <span class="impl-header__name">{{ dialer | split(pat="-") | first }}</span>
                                        <span class="impl-header__version">{{ dialer | split(pat="-") | slice(start=1) | join(sep="-") }}</span>
                                    </th>
                                    {% for listener in transport_listeners | sort %}
                                        {# Look up results for all secure/muxer combinations #}
                                        {% set_global cell_statuses = [] %}
                                        {% for test in data.transport.results %}
                                            {% if test.dialer == dialer and test.listener == listener and test.transport == transport_name %}
                                                {% set_global cell_statuses = cell_statuses | concat(with=test.status) %}
                                            {% endif %}
                                        {% endfor %}

                                        {% if cell_statuses | length == 0 %}
                                        <td><span class="status-cell status-cell--na">-</span></td>
                                        {% elif "fail" in cell_statuses %}
                                        <td><span class="status-cell status-cell--fail" title="Some tests failed">X</span></td>
                                        {% elif cell_statuses | length > 0 and "pass" in cell_statuses %}
                                        <td><span class="status-cell status-cell--pass">✓</span></td>
                                        {% else %}
                                        <td><span class="status-cell status-cell--na">-</span></td>
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}

                {% else %}
                <div class="status-section__notice">
                    <p>Transport interoperability results are not yet available.</p>
                    <p>Results are generated daily by the <a href="https://github.com/libp2p/test-plans" target="_blank" rel="noopener noreferrer">libp2p test-plans</a> repository.</p>
                </div>
                {% endif %}
            </section>

            {# Performance Section #}
            <section class="status-section" id="performance">
                <header class="status-section__header">
                    <h2 class="status-section__title">Performance Benchmarks</h2>
                    <p class="status-section__description">
                        Performance measurements across different libp2p implementations, measuring upload/download throughput and latency.
                    </p>
                </header>

                {% if data and data.perf and data.perf.results %}
                {# Show summary #}
                <div class="test-run-info">
                    <div class="test-run-info__item">
                        <strong>Main Tests:</strong>
                        <span>{{ data.perf.summary["main-total"] }}</span>
                    </div>
                    <div class="test-run-info__item">
                        <strong>Passed:</strong>
                        <span class="status-text--pass">{{ data.perf.summary["main-passed"] }}</span>
                    </div>
                    <div class="test-run-info__item">
                        <strong>Failed:</strong>
                        <span class="status-text--fail">{{ data.perf.summary["main-failed"] }}</span>
                    </div>
                    {% if data.perf.summary["baseline-total"] > 0 %}
                    <div class="test-run-info__item">
                        <strong>Baselines:</strong>
                        <span>{{ data.perf.summary["baseline-passed"] }}/{{ data.perf.summary["baseline-total"] }}</span>
                    </div>
                    {% endif %}
                </div>

                {# Box plot images #}
                {% if data["box-plots"] %}
                <div class="perf-boxplots">
                    {% if data["box-plots"].upload %}
                    <div class="perf-boxplots__item">
                        <h4>Upload Throughput</h4>
                        <img src="/data/status/boxplot-upload.png" alt="Upload Throughput Box Plot" class="perf-boxplots__image" loading="lazy">
                    </div>
                    {% endif %}
                    {% if data["box-plots"].download %}
                    <div class="perf-boxplots__item">
                        <h4>Download Throughput</h4>
                        <img src="/data/status/boxplot-download.png" alt="Download Throughput Box Plot" class="perf-boxplots__image" loading="lazy">
                    </div>
                    {% endif %}
                    {% if data["box-plots"].latency %}
                    <div class="perf-boxplots__item">
                        <h4>Latency</h4>
                        <img src="/data/status/boxplot-latency.png" alt="Latency Box Plot" class="perf-boxplots__image" loading="lazy">
                    </div>
                    {% endif %}
                </div>
                {% endif %}

                {% else %}
                <div class="status-section__notice">
                    <p>Performance benchmark results are not yet available.</p>
                    <p>Results are generated daily by the <a href="https://github.com/libp2p/test-plans" target="_blank" rel="noopener noreferrer">libp2p test-plans</a> repository.</p>
                </div>
                {% endif %}
            </section>

            {# Hole Punching Section #}
            <section class="status-section" id="hole-punching">
                <header class="status-section__header">
                    <h2 class="status-section__title">Hole Punching</h2>
                    <p class="status-section__description">
                        Tests verifying NAT traversal capabilities across implementations using relay nodes.
                    </p>
                </header>

                {% if data and data["hole-punch"] and data["hole-punch"].results %}
                {# Show summary #}
                <div class="test-run-info">
                    <div class="test-run-info__item">
                        <strong>Total:</strong>
                        <span>{{ data["hole-punch"].summary.total }}</span>
                    </div>
                    <div class="test-run-info__item">
                        <strong>Passed:</strong>
                        <span class="status-text--pass">{{ data["hole-punch"].summary.passed }}</span>
                    </div>
                    <div class="test-run-info__item">
                        <strong>Failed:</strong>
                        <span class="status-text--fail">{{ data["hole-punch"].summary.failed }}</span>
                    </div>
                </div>

                {# Extract unique relays #}
                {% set_global hp_relays = [] %}
                {% set_global hp_dialers = [] %}
                {% set_global hp_listeners = [] %}
                {% set_global hp_transports = [] %}
                {% for test in data["hole-punch"].results %}
                    {% if test.relay not in hp_relays %}
                        {% set_global hp_relays = hp_relays | concat(with=test.relay) %}
                    {% endif %}
                    {% if test.dialer not in hp_dialers %}
                        {% set_global hp_dialers = hp_dialers | concat(with=test.dialer) %}
                    {% endif %}
                    {% if test.listener not in hp_listeners %}
                        {% set_global hp_listeners = hp_listeners | concat(with=test.listener) %}
                    {% endif %}
                    {% if test.transport not in hp_transports %}
                        {% set_global hp_transports = hp_transports | concat(with=test.transport) %}
                    {% endif %}
                {% endfor %}

                {# Generate a table for each relay type #}
                {% for relay in hp_relays | sort %}
                <div class="status-section__subsection">
                    <h3 class="status-section__subtitle">Relay: {{ relay }}</h3>
                    <div class="status-grid-wrapper">
                        <table class="status-grid__table">
                            <thead>
                                <tr>
                                    <th>Dialer \ Listener</th>
                                    {% for listener in hp_listeners | sort %}
                                    <th class="impl-header">
                                        <span class="impl-header__name">{{ listener | split(pat="-") | first }}</span>
                                        <span class="impl-header__version">{{ listener | split(pat="-") | slice(start=1) | join(sep="-") }}</span>
                                    </th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for dialer in hp_dialers | sort %}
                                <tr>
                                    <th class="impl-header">
                                        <span class="impl-header__name">{{ dialer | split(pat="-") | first }}</span>
                                        <span class="impl-header__version">{{ dialer | split(pat="-") | slice(start=1) | join(sep="-") }}</span>
                                    </th>
                                    {% for listener in hp_listeners | sort %}
                                        {# Collect all transport results for this dialer/listener/relay combination #}
                                        {% set_global cell_results = [] %}
                                        {% for test in data["hole-punch"].results %}
                                            {% if test.dialer == dialer and test.listener == listener and test.relay == relay %}
                                                {% set result_item = test.transport ~ ":" ~ test.status %}
                                                {% set_global cell_results = cell_results | concat(with=result_item) %}
                                            {% endif %}
                                        {% endfor %}

                                        {% if cell_results | length == 0 %}
                                        <td><span class="status-cell status-cell--na">-</span></td>
                                        {% else %}
                                            {# Show transport abbreviations with status #}
                                            {% set_global has_pass = false %}
                                            {% set_global has_fail = false %}
                                            {% for result in cell_results %}
                                                {% if "pass" in result %}
                                                    {% set_global has_pass = true %}
                                                {% endif %}
                                                {% if "fail" in result %}
                                                    {% set_global has_fail = true %}
                                                {% endif %}
                                            {% endfor %}

                                            {% if has_fail %}
                                            <td><span class="status-cell status-cell--fail" title="{{ cell_results | join(sep=', ') }}">X</span></td>
                                            {% elif has_pass %}
                                            <td><span class="status-cell status-cell--pass" title="{{ cell_results | join(sep=', ') }}">✓</span></td>
                                            {% else %}
                                            <td><span class="status-cell status-cell--na">-</span></td>
                                            {% endif %}
                                        {% endif %}
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                {% endfor %}

                {% else %}
                <div class="status-section__notice">
                    <p>Hole punching test results are not yet available.</p>
                    <p>Results are generated daily by the <a href="https://github.com/libp2p/test-plans" target="_blank" rel="noopener noreferrer">libp2p test-plans</a> repository.</p>
                </div>
                {% endif %}
            </section>

            {# Test Plan Link #}
            <section class="status-section">
                <p>
                    These results are generated automatically by the
                    <a href="https://github.com/libp2p/test-plans" target="_blank" rel="noopener noreferrer">libp2p test-plans</a>
                    repository. View detailed results and contribute to the test suite there.
                </p>
            </section>
        </div>

        {# Table of Contents #}
        <aside class="status-toc">
            <p class="status-toc__title">Sections</p>
            <ul class="status-toc__list">
                <li><a href="#transport" class="status-toc__link">Transport</a></li>
                <li><a href="#performance" class="status-toc__link">Performance</a></li>
                <li><a href="#hole-punching" class="status-toc__link">Hole Punching</a></li>
            </ul>
        </aside>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Update last updated time if not from data
(function() {
    const lastUpdated = document.getElementById('last-updated');
    if (lastUpdated && lastUpdated.textContent === 'Loading...') {
        lastUpdated.textContent = new Date().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }
})();

// TOC active state
document.addEventListener('DOMContentLoaded', function() {
    const tocLinks = document.querySelectorAll('.status-toc__link');
    const sections = document.querySelectorAll('.status-section[id]');

    function highlightTOC() {
        const scrollPosition = window.scrollY + 150;

        let current = null;
        sections.forEach(section => {
            if (section.offsetTop <= scrollPosition) {
                current = section.id;
            }
        });

        tocLinks.forEach(link => {
            link.classList.remove('status-toc__link--active');
            if (link.getAttribute('href') === '#' + current) {
                link.classList.add('status-toc__link--active');
            }
        });
    }

    window.addEventListener('scroll', highlightTOC);
    highlightTOC();
});
</script>
{% endblock %}
