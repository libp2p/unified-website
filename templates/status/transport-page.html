{% extends "base.html" %}
{% import "macros.html" as macros %}

{% block title %}{{ page.title }} - Transport Status{% endblock %}

{% block body_class %}status{% endblock %}
{% block main_class %}status-layout{% endblock %}

{% block content %}
{% include "components/status-sidebar.html" %}

{% set data = load_data(path="static/data/status/interop-results.yml", format="yaml", required=false) %}
{% set combo = page.extra.combo %}

<div class="status-main">
    <div class="status-content">
        <article class="status-article">
            {# Breadcrumbs #}
            <nav class="breadcrumbs" aria-label="Breadcrumb">
                <span class="breadcrumbs__item">
                    <a href="{{ config.base_url }}/status/">Status</a>
                </span>
                <span class="breadcrumbs__separator">/</span>
                <span class="breadcrumbs__item">
                    <a href="{{ config.base_url }}/status/transport/">Transport</a>
                </span>
                <span class="breadcrumbs__separator">/</span>
                <span class="breadcrumbs__item">{{ page.title }}</span>
            </nav>

            <header class="status-header">
                <h1 class="status-header__title">{{ page.title }}</h1>
            </header>

            {% if data and data.transport and data.transport.results %}

            {# Pre-filter results and extract unique dialers/listeners for this combo #}
            {%- set_global filtered_results = [] -%}
            {%- set_global combo_dialers = [] -%}
            {%- set_global combo_listeners = [] -%}
            {%- set_global combo_passed = 0 -%}
            {%- set_global combo_failed = 0 -%}

            {%- for test in data.transport.results -%}
                {%- if test["secure-channel"] and test.muxer -%}
                    {%- set test_combo = test.transport ~ " - " ~ test["secure-channel"] ~ " - " ~ test.muxer -%}
                {%- else -%}
                    {%- set test_combo = test.transport -%}
                {%- endif -%}

                {%- if test_combo == combo -%}
                    {%- set_global filtered_results = filtered_results | concat(with=test) -%}
                    {%- if test.dialer not in combo_dialers -%}
                        {%- set_global combo_dialers = combo_dialers | concat(with=test.dialer) -%}
                    {%- endif -%}
                    {%- if test.listener not in combo_listeners -%}
                        {%- set_global combo_listeners = combo_listeners | concat(with=test.listener) -%}
                    {%- endif -%}
                    {%- if test.status == "pass" -%}
                        {%- set_global combo_passed = combo_passed + 1 -%}
                    {%- elif test.status == "fail" -%}
                        {%- set_global combo_failed = combo_failed + 1 -%}
                    {%- endif -%}
                {%- endif -%}
            {%- endfor -%}

            {# Summary stats #}
            <div class="test-run-info">
                <div class="test-run-info__stats">
                    <div class="test-run-info__item">
                        <strong>Total:</strong>
                        <span>{{ filtered_results | length }}</span>
                    </div>
                    <div class="test-run-info__item">
                        <strong>Passed:</strong>
                        <span class="status-text--pass">{{ combo_passed }}</span>
                    </div>
                    <div class="test-run-info__item">
                        <strong>Failed:</strong>
                        <span class="status-text--fail">{{ combo_failed }}</span>
                    </div>
                </div>
                <div class="test-run-info__legend">
                    <div class="test-run-info__item">
                        <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="8" r="7" fill="#22c55e"/></svg>
                        <span>Pass</span>
                    </div>
                    <div class="test-run-info__item">
                        <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="8" r="7" fill="#ef4444"/></svg>
                        <span>Fail</span>
                    </div>
                    <div class="test-run-info__item">
                        <span class="status-indicator status-indicator--na">-</span>
                        <span>N/A</span>
                    </div>
                </div>
            </div>

            {# Dialer x Listener table #}
            <div class="status-section__subsection">
                <div class="status-grid-wrapper">
                    <table class="status-grid__table status-grid__table--compact">
                        <thead>
                            <tr>
                                <th class="corner-cell">
                                    <div class="corner-cell__container">
                                        <span class="corner-cell__dialer">Dialer</span>
                                        <span class="corner-cell__listener">Listener</span>
                                    </div>
                                </th>
                                {% for listener in combo_listeners | sort %}
                                <th class="rotate"><div><span>{{ listener }}</span></div></th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for dialer in combo_dialers | sort %}
                            <tr>
                                <th class="row-header">{{ dialer }}</th>
                                {% for listener in combo_listeners | sort %}
                                    {%- set_global cell_status = "na" -%}
                                    {%- for test in filtered_results -%}
                                        {%- if test.dialer == dialer and test.listener == listener -%}
                                            {%- set_global cell_status = test.status -%}
                                        {%- endif -%}
                                    {%- endfor -%}
                                    <td class="status-cell-td">
                                        {% if cell_status == "pass" %}
                                        <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="8" r="7" fill="#22c55e"/></svg>
                                        {% elif cell_status == "fail" %}
                                        <svg width="16" height="16" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><circle cx="8" cy="8" r="7" fill="#ef4444"/></svg>
                                        {% else %}
                                        <span class="status-indicator status-indicator--na" title="N/A">-</span>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            {% else %}
            <div class="status-section__notice">
                <p>Transport interoperability results are not yet available.</p>
                <p>Results are generated daily by the <a href="https://github.com/libp2p/unified-testing" target="_blank" rel="noopener noreferrer">libp2p unified-testing</a> repository.</p>
            </div>
            {% endif %}
        </article>
    </div>
</div>
{% endblock %}
